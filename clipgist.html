<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClipGist - Clipboard to Gist</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        h1 {
            color: #00d9ff;
        }
        #paste-zone {
            border: 3px dashed #00d9ff;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background: #16213e;
            cursor: pointer;
            transition: all 0.3s;
        }
        #paste-zone:hover, #paste-zone.dragover {
            background: #1f3460;
            border-color: #00ff88;
        }
        #paste-zone p {
            font-size: 18px;
            margin: 0;
        }
        .format-section {
            background: #16213e;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        .format-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .format-type {
            color: #00ff88;
            font-weight: bold;
            font-size: 16px;
        }
        .format-size {
            color: #888;
            font-size: 14px;
        }
        .format-content {
            background: #0f0f23;
            border-radius: 4px;
            padding: 12px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        .format-content pre {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .format-content img {
            max-width: 100%;
            height: auto;
        }
        #results {
            margin-top: 20px;
        }
        .no-data {
            color: #888;
            font-style: italic;
        }
        .collapsed .format-content {
            display: none;
        }
        .collapsed .format-header {
            cursor: pointer;
        }
        .collapse-indicator {
            color: #00d9ff;
            margin-right: 8px;
            font-family: monospace;
        }
        .format-section.collapsed {
            opacity: 0.7;
        }
        .format-section.collapsed:hover {
            opacity: 1;
        }
        .copy-btn, .gist-btn {
            background: #00d9ff;
            color: #1a1a2e;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 4px;
        }
        .copy-btn:hover, .gist-btn:hover {
            background: #00ff88;
        }
        .gist-btn {
            background: #6e40c9;
        }
        .gist-btn:hover {
            background: #8957e5;
        }
        .gist-btn:disabled {
            background: #444;
            cursor: not-allowed;
        }
        .auth-container {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-right: 8px;
        }
        .auth-btn {
            background: #238636;
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }
        .auth-btn:hover {
            background: #2ea043;
        }
        .auth-btn:disabled {
            background: #444;
            cursor: not-allowed;
        }
        .logout-btn {
            background: #da3633;
        }
        .logout-btn:hover {
            background: #f85149;
        }
        .gist-result {
            margin-top: 12px;
            padding: 12px;
            background: #0f3460;
            border-radius: 4px;
        }
        .gist-result a {
            color: #00d9ff;
            text-decoration: none;
        }
        .gist-result a:hover {
            text-decoration: underline;
        }
        #summary {
            background: #0f3460;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        kbd {
            background: #333;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>ClipGist</h1>
    <p style="color: #888; margin-top: -10px; margin-bottom: 20px;">粘贴内容，一键分享到 Gist</p>

    <div id="paste-zone" tabindex="0">
        <p>Click here and press <kbd>Ctrl+V</kbd> / <kbd>Cmd+V</kbd> to paste</p>
        <p style="color: #888; margin-top: 10px;">Or drag and drop content here</p>
    </div>

    <div id="summary" style="display: none;"></div>
    <div id="results"></div>

    <script>
        const pasteZone = document.getElementById('paste-zone');
        const results = document.getElementById('results');
        const summary = document.getElementById('summary');

        // Auth state management
        function getAuthState() {
            const token = localStorage.getItem('github-gist-token');
            const username = localStorage.getItem('github-username');
            return { token, username };
        }

        function setAuthState(token, username) {
            localStorage.setItem('github-gist-token', token);
            localStorage.setItem('github-username', username);
        }

        function clearAuthState() {
            localStorage.removeItem('github-gist-token');
            localStorage.removeItem('github-username');
        }

        function isLoggedIn() {
            const { token, username } = getAuthState();
            return !!(token && username);
        }

        // Returns HTML for auth button (login or logged-in status)
        function getAuthButtonHtml() {
            const { token, username } = getAuthState();
            if (token && username) {
                return `
                    <span style="color: #00ff88; font-size: 12px;">@${escapeHtml(username)}</span>
                    <button class="copy-btn logout-btn" onclick="event.stopPropagation(); logout()">登出</button>
                `;
            } else {
                return `
                    <button class="auth-btn" onclick="event.stopPropagation(); showLoginPrompt()">
                        <svg style="width:14px;height:14px;vertical-align:middle;margin-right:4px;" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
                        </svg>
                        登录 GitHub
                    </button>
                `;
            }
        }

        // Show login prompt
        async function showLoginPrompt() {
            const token = prompt(
                '请输入 GitHub Personal Access Token (需要 gist 权限):\n\n' +
                '创建 Token: https://github.com/settings/tokens/new?scopes=gist\n\n' +
                '输入 Token:'
            );

            if (!token || !token.trim()) return;

            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: { 'Authorization': `Bearer ${token.trim()}` }
                });

                if (!response.ok) throw new Error('Token 无效');

                const userData = await response.json();
                setAuthState(token.trim(), userData.login);
                alert(`登录成功！欢迎 @${userData.login}`);

                // Update auth button
                const htmlSection = document.querySelector('[data-type="text/html"]');
                if (htmlSection) {
                    const authContainer = htmlSection.querySelector('.auth-container');
                    if (authContainer) {
                        authContainer.innerHTML = getAuthButtonHtml();
                    }
                }
            } catch (error) {
                alert('登录失败: ' + error.message);
            }
        }

        function logout() {
            clearAuthState();
            const htmlSection = document.querySelector('[data-type="text/html"]');
            if (htmlSection) {
                const authContainer = htmlSection.querySelector('.auth-container');
                if (authContainer) {
                    authContainer.innerHTML = getAuthButtonHtml();
                }
            }
        }

        async function createGist(htmlContent, button) {
            const { token } = getAuthState();
            if (!token) {
                alert('请先登录 GitHub');
                showLoginPrompt();
                return;
            }

            button.disabled = true;
            button.textContent = 'Creating...';

            try {
                const response = await fetch('https://api.github.com/gists', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github+json'
                    },
                    body: JSON.stringify({
                        description: 'Clipboard HTML - ' + new Date().toISOString(),
                        public: false,
                        files: {
                            'clipboard.html': {
                                content: htmlContent
                            }
                        }
                    })
                });

                if (response.status === 401) {
                    clearAuthState();
                    alert('Token 已失效，请重新登录');
                    button.textContent = 'Create Gist';
                    button.disabled = false;
                    return;
                }

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to create gist');
                }

                const gist = await response.json();
                const gistId = gist.id;
                const previewUrl = `https://gistpreview.github.io/?${gistId}`;
                const gistUrl = gist.html_url;

                // Show result
                let resultDiv = button.parentElement.querySelector('.gist-result');
                if (!resultDiv) {
                    resultDiv = document.createElement('div');
                    resultDiv.className = 'gist-result';
                    button.parentElement.appendChild(resultDiv);
                }

                resultDiv.innerHTML = `
                    <strong>Gist created!</strong><br>
                    <a href="${gistUrl}" target="_blank">View Gist: ${gistId}</a><br>
                    <a href="${previewUrl}" target="_blank">Preview: ${previewUrl}</a>
                    <button class="copy-btn" style="margin-top: 8px;" onclick="navigator.clipboard.writeText('${previewUrl}'); this.textContent='Copied!';">Copy Preview URL</button>
                `;

                button.textContent = 'Create Gist';
                button.disabled = false;

            } catch (error) {
                alert('Error: ' + error.message);
                button.textContent = 'Create Gist';
                button.disabled = false;
            }
        }

        pasteZone.addEventListener('paste', handlePaste);
        pasteZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            pasteZone.classList.add('dragover');
        });
        pasteZone.addEventListener('dragleave', () => {
            pasteZone.classList.remove('dragover');
        });
        pasteZone.addEventListener('drop', handleDrop);

        // Also listen globally
        document.addEventListener('paste', handlePaste);

        function handleDrop(e) {
            e.preventDefault();
            pasteZone.classList.remove('dragover');
            displayClipboardData(e.dataTransfer);
        }

        function handlePaste(e) {
            e.preventDefault();
            displayClipboardData(e.clipboardData);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function displayClipboardData(clipboardData) {
            results.innerHTML = '';

            const types = clipboardData.types;
            const items = clipboardData.items;
            const hasHtml = types.includes('text/html');

            // Sort types to show text/html first if present
            const sortedTypes = [...types].sort((a, b) => {
                if (a === 'text/html') return -1;
                if (b === 'text/html') return 1;
                return 0;
            });

            summary.style.display = 'block';
            summary.innerHTML = `<strong>Found ${types.length} format(s):</strong> ${types.map(t => `<code>${t}</code>`).join(', ')}`;

            // Process each type
            for (const type of sortedTypes) {
                const section = document.createElement('div');
                section.className = 'format-section';

                if (type === 'Files') {
                    // Handle files
                    const files = clipboardData.files;
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        const fileSection = createFileSection(file);
                        results.appendChild(fileSection);
                    }
                    continue;
                }

                const data = clipboardData.getData(type);
                const size = new Blob([data]).size;

                // Collapse text/plain and text/rtf if text/html is present
                const shouldCollapse = hasHtml && (type === 'text/plain' || type === 'text/rtf');
                const collapseClass = shouldCollapse ? ' collapsed' : '';
                const indicator = `<span class="collapse-indicator">${shouldCollapse ? '▶' : '▼'}</span>`;

                // Add auth and Gist buttons for HTML content
                const isHtml = type === 'text/html';
                const authAndGistButtons = isHtml
                    ? `<span class="auth-container">${getAuthButtonHtml()}</span>
                       <button class="gist-btn" onclick="event.stopPropagation(); createGist(this.closest('.format-section').dataset.content, this)">Create Gist</button>`
                    : '';

                section.className = 'format-section' + collapseClass;
                if (isHtml) {
                    section.dataset.type = 'text/html';
                }
                section.innerHTML = `
                    <div class="format-header" onclick="toggleCollapse(this.parentElement)">
                        <span class="format-type">${indicator}${escapeHtml(type)}</span>
                        <span>
                            <span class="format-size">${formatBytes(size)}</span>
                            <button class="copy-btn" onclick="event.stopPropagation(); copyToClipboard(this, '${type}')">Copy</button>
                            ${authAndGistButtons}
                        </span>
                    </div>
                    <div class="format-content">
                        <pre id="content-${type.replace(/[^a-z0-9]/gi, '-')}"></pre>
                    </div>
                `;

                results.appendChild(section);

                const pre = section.querySelector('pre');

                if (type.includes('html')) {
                    // Show both raw HTML and rendered preview
                    pre.textContent = data;

                    const previewDiv = document.createElement('div');
                    previewDiv.style.marginTop = '12px';
                    previewDiv.style.padding = '12px';
                    previewDiv.style.background = '#fff';
                    previewDiv.style.color = '#000';
                    previewDiv.style.borderRadius = '4px';
                    previewDiv.innerHTML = '<strong style="color:#666;">Rendered preview:</strong><hr>' + data;
                    section.querySelector('.format-content').appendChild(previewDiv);
                } else if (type.startsWith('image/')) {
                    pre.remove();
                    const img = document.createElement('img');
                    img.src = `data:${type};base64,${btoa(data)}`;
                    section.querySelector('.format-content').appendChild(img);
                } else {
                    pre.textContent = data || '(empty)';
                }

                // Store data for copy
                section.dataset.content = data;
            }

            // Also check for items (for binary data like images)
            if (items) {
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    if (item.kind === 'file') {
                        const file = item.getAsFile();
                        if (file && !types.includes('Files')) {
                            const fileSection = await createFileSection(file);
                            results.appendChild(fileSection);
                        }
                    }
                }
            }

            if (results.children.length === 0) {
                results.innerHTML = '<p class="no-data">No clipboard data detected</p>';
            }
        }

        async function createFileSection(file) {
            const section = document.createElement('div');
            section.className = 'format-section';

            section.innerHTML = `
                <div class="format-header">
                    <span class="format-type">File: ${escapeHtml(file.name)}</span>
                    <span class="format-size">${file.type} - ${formatBytes(file.size)}</span>
                </div>
                <div class="format-content"></div>
            `;

            const content = section.querySelector('.format-content');

            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                content.appendChild(img);
            } else if (file.type.startsWith('text/')) {
                const text = await file.text();
                const pre = document.createElement('pre');
                pre.textContent = text;
                content.appendChild(pre);
            } else {
                content.innerHTML = `<p class="no-data">Binary file (${file.type || 'unknown type'})</p>`;
            }

            return section;
        }

        function copyToClipboard(btn, type) {
            const section = btn.closest('.format-section');
            const content = section.dataset.content;
            navigator.clipboard.writeText(content).then(() => {
                const original = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = original, 1000);
            });
        }

        function toggleCollapse(section) {
            section.classList.toggle('collapsed');
            const indicator = section.querySelector('.collapse-indicator');
            indicator.textContent = section.classList.contains('collapsed') ? '▶' : '▼';
        }

        // Focus paste zone on load
        pasteZone.focus();
    </script>
</body>
</html>
